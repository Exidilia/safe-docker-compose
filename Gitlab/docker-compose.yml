version: '3.8'

services:
  gitlab:
    image: 'gitlab/gitlab-ee:${GITLAB_VERSION}'
    container_name: gitlab_server
    restart: always
    hostname: '${GITLAB_HOSTNAME}'
    environment:
      GITLAB_OMNIBUS_CONFIG: |
        # --- Security & Access ---
        external_url 'https://${GITLAB_HOSTNAME}'
        gitlab_rails['gitlab_shell_ssh_port'] = ${GITLAB_SHELL_SSH_PORT}
        gitlab_rails['time_zone'] = '${TIMEZONE}'
        
        # --- Container Registry (DevSecOps Vital) ---
        # فعال‌سازی رجیستری برای نگهداری ایمیج‌های امن
        registry_external_url 'https://${GITLAB_HOSTNAME}:5050'
        
        # --- NGINX Hardening ---
        # ریدایرکت خودکار به HTTPS
        nginx['redirect_http_to_https'] = true
        nginx['ssl_certificate'] = "/etc/gitlab/ssl/${GITLAB_HOSTNAME}.crt"
        nginx['ssl_certificate_key'] = "/etc/gitlab/ssl/${GITLAB_HOSTNAME}.key"
        # فعال‌سازی HTTP/2 برای سرعت و امنیت بیشتر
        nginx['http2_enabled'] = true
        
        # --- Monitoring & Observability ---
        # برای ارسال متریک‌ها به پرومتئوس (اگر تیم شما مانیتورینگ دارد)
        prometheus['enable'] = true
        
        # --- Resource Limits ---
        # محدود کردن Workerها برای جلوگیری از مصرف کل رم سیستم
        puma['worker_processes'] = 2
        sidekiq['max_concurrency'] = 10
        
    ports:
      - '80:80'
      - '443:443'
      - '${GITLAB_SHELL_SSH_PORT}:22' # SSH Access via port 2424
      - '5050:5050' # Container Registry
    volumes:
      - './config:/etc/gitlab'
      - './logs:/var/log/gitlab'
      - './data:/var/opt/gitlab'
      # Mount SSL certs (شما باید این‌ها را بسازید)
      - './ssl:/etc/gitlab/ssl'
    networks:
      - gitlab_net
      - jiranet # اتصال به شبکه جیرا برای Integration
    shm_size: '256m' # الزامی برای متریک‌های Prometheus
    deploy:
      resources:
        limits:
          memory: 6G # گیت‌لب بسیار سنگین است
          cpus: '2.0'
    healthcheck:
      test: ["CMD-SHELL", "curl -k -f https://localhost/-/health || exit 1"]
      interval: 60s
      timeout: 10s
      retries: 5

networks:
  gitlab_net:
    driver: bridge
  jiranet: # شبکه مشترک با جیرا
    external: true

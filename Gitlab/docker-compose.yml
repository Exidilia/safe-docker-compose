version: '3.8'

services:
  gitlab:
    image: 'gitlab/gitlab-ee:${GITLAB_VERSION}'
    container_name: gitlab_server
    restart: always
    hostname: '${GITLAB_HOSTNAME}'
    environment:
      GITLAB_OMNIBUS_CONFIG: |
        # --- Security & Access ---
        external_url 'https://${GITLAB_HOSTNAME}'
        gitlab_rails['gitlab_shell_ssh_port'] = ${GITLAB_SHELL_SSH_PORT}
        gitlab_rails['time_zone'] = '${TIMEZONE}'
        
        # --- Container Registry (DevSecOps Vital) ---
        # enabling registery for safe docker images
        registry_external_url 'https://${GITLAB_HOSTNAME}:5050'
        
        # --- NGINX Hardening ---
        # auto redirect to HTTPS
        nginx['redirect_http_to_https'] = true
        nginx['ssl_certificate'] = "/etc/gitlab/ssl/${GITLAB_HOSTNAME}.crt"
        nginx['ssl_certificate_key'] = "/etc/gitlab/ssl/${GITLAB_HOSTNAME}.key"
        # enabling HTTP/2 for more spped and security
        nginx['http2_enabled'] = true
        
        # --- Monitoring & Observability ---
        # to send metrics to prometheus
        prometheus['enable'] = true
        
        # --- Resource Limits ---
        # limitting workers
        puma['worker_processes'] = 2
        sidekiq['max_concurrency'] = 10
        
    ports:
      - '80:80'
      - '443:443'
      - '${GITLAB_SHELL_SSH_PORT}:22' # SSH Access via port 2424
      - '5050:5050' # Container Registry
    volumes:
      - './config:/etc/gitlab'
      - './logs:/var/log/gitlab'
      - './data:/var/opt/gitlab'
      # Mount SSL certs (you should build them first)
      - './ssl:/etc/gitlab/ssl'
    networks:
      - gitlab_net
      - jiranet # jira integration
    shm_size: '256m' # prometheus integration
    deploy:
      resources:
        limits:
          memory: 6G # too heavy :)
          cpus: '2.0'
    healthcheck:
      test: ["CMD-SHELL", "curl -k -f https://localhost/-/health || exit 1"]
      interval: 60s
      timeout: 10s
      retries: 5

networks:
  gitlab_net:
    driver: bridge
  jiranet: # shared network with jiraÿß
    external: true
